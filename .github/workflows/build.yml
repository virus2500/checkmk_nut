name: build

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*.*.*'
  pull_request:

jobs:
  build_package:
    name: Build Checkmk package
    # This job will run on 'ubuntu-latest'.
    # On GitHub, this is GitHub-hosted ubuntu-latest.
    # On Gitea, this will be your Gitea runner that maps to 'ubuntu-latest' (or its default).
    # Crucially, this job's internal upload needs to be compatible with Gitea's Node.js.
    runs-on: ubuntu-latest
    container:
      image: ${{ vars.CHECK_MK_IMAGE }}

    env:
      OMD_ROOT: /omd/sites/cmk
      OMD_SITE: cmk
      CMK_SITE_ID: cmk
      WORKSPACE: ${{ github.workspace }}

    steps:
      - name: Initialize Checkmk Site
        run: /docker-entrypoint.sh /bin/true

      - uses: actions/checkout@v2

      - name: Setup links
        run: .devcontainer/symlink.sh

      - name: Update GITHUB_PATH
        run: echo "/omd/sites/cmk/bin" >> $GITHUB_PATH

      - name: Build Extension
        run: .devcontainer/build.sh
        id: cmkpkg # ID to capture outputs

      - name: Debug package outputs
        run: |
          echo "PKGFILE: ${{ steps.cmkpkg.outputs.pkgfile }}"
          echo "PKGNAME: ${{ steps.cmkpkg.outputs.pkgname }}"
          echo "PKGVERSION: ${{ steps.cmkpkg.outputs.pkgversion }}"

      - name: Debug GitHub context
        run: |
          echo "server_url: ${{ github.server_url }}"
          echo "host: ${{ github.host }}"

      - name: Upload artifact (GitHub only)
        if: startsWith(github.server_url, 'https://github.com')
        uses: actions/upload-artifact@v4
        with:
          name: built-mkp-artifact
          path: ${{ steps.cmkpkg.outputs.pkgfile }}

      - name: Upload artifact (Gitea only)
        if: ${{ !startsWith(github.server_url, 'https://github.com') }}
        uses: actions/upload-artifact@v3
        with:
          name: built-mkp-artifact
          path: ${{ steps.cmkpkg.outputs.pkgfile }}

#      - name: Upload mkp artifact for subsequent jobs (Internal Transfer - Gitea compatible)
#        # *** CRITICAL CHANGE HERE ***
#        # This MUST be v3 because the build_package job itself runs on Gitea,
#        # and Gitea's Node.js is too old for v4.
#        # This will still work on GitHub's newer runners for internal transfer.
#        uses: actions/upload-artifact@v3
#        with:
#          name: built-mkp-artifact # A fixed name for the artifact for later download
#          path: ${{ steps.cmkpkg.outputs.pkgfile }}

      - name: Get Current Date for Body (optional)
        id: get_current_date
        run: echo "date=$(date +'%Y-%m-%d %H:%M:%S %Z')" >> "$GITHUB_OUTPUT"

  upload_to_github:
    name: Upload to GitHub
    runs-on: ubuntu-latest # This will always be a GitHub-hosted runner
    needs: build_package # This job depends on the successful build
    if: ${{ startsWith(github.server_url, 'https://github.com') }} # Only run on GitHub

    steps:
      - name: Download built mkp artifact
        # Use v4 for download on GitHub as GitHub's runners support it
        uses: actions/download-artifact@v4
        with:
          name: built-mkp-artifact
          path: . # Download to the current directory

      - name: Get artifact filename
        id: get_pkg_name
        run: |
          echo "pkgfile=$(ls *.mkp | head -n 1)" >> "$GITHUB_OUTPUT"

      - name: Upload mkp artifact (GitHub)
        # Use v4 for final upload to GitHub's artifact storage
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.get_pkg_name.outputs.pkgfile }}
          path: ${{ steps.get_pkg_name.outputs.pkgfile }}

  upload_to_gitea:
    name: Upload to Gitea
    container:
      image: gitea.home.lan/mkronika/ubuntu2404:latest
    runs-on: self-hosted # Your specific Gitea runner label
    needs: build_package # This job depends on the successful build
    if: ${{ !startsWith(github.server_url, 'https://github.com') }} # Only run if NOT on GitHub (i.e., on Gitea)

    steps:
      - name: Download built mkp artifact
        # Use v3 for download on Gitea due to Node.js compatibility
        uses: actions/download-artifact@v3
        with:
          name: built-mkp-artifact
          path: . # Download to the current directory

      - name: Get artifact filename
        id: get_pkg_name
        run: |
          echo "pkgfile=$(ls *.mkp | head -n 1)" >> "$GITHUB_OUTPUT"

      - name: Upload mkp artifact (Gitea)
        # Use v3 for final upload on Gitea due to Node.js compatibility
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.get_pkg_name.outputs.pkgfile }}
          path: ${{ steps.get_pkg_name.outputs.pkgfile }}
